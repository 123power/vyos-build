name: Build VyOS 1.4 Sagitta ISO (Clean)

on:
  workflow_dispatch:

jobs:
  build-sagitta:
    runs-on: ubuntu-latest
    container:
      image: debian:12
      options: --privileged

    steps:
      - name: Install base dependencies
        run: |
          set -eux
          apt-get update
          apt-get install -y \
            git \
            curl \
            ca-certificates \
            gnupg \
            python3 \
            python3-pip \
            python3-tomli \
            python3-jinja2 \
            python3-git \
            python3-psutil \
            python3-pystache \
            devscripts \
            live-build \
            debootstrap \
            squashfs-tools \
            xorriso \
            syslinux \
            isolinux \
            dosfstools \
            grub-pc-bin \
            grub-efi-amd64-bin

      - name: Clone clean upstream vyos-build (sagitta)
        run: |
          set -eux
          git clone --depth 1 --branch sagitta https://github.com/vyos/vyos-build.git
          cd vyos-build
          git status

      - name: Force sterile live-build environment
        run: |
          set -eux
          cd vyos-build

          # HARD RESET anything cached
          rm -rf .build live-build cache || true
          rm -rf /var/cache/live-build || true

          # NO ubuntu mirrors, EVER
          sed -i 's|archive.ubuntu.com|deb.debian.org|g' scripts/image-build/*.py || true

      - name: Build VyOS ISO (NO CACHE)
        run: |
          set -eux
          cd vyos-build

          export VYOS_BUILD_FLAVOR=sagitta
          export LB_NO_CACHE=true

          ./build-vyos-image \
            --architecture amd64 \
            --build-by "github-actions" \
            --build-type release \
            --version 1.4.0-sagitta-custom

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: vyos-1.4-sagitta-iso
          path: vyos-build/build/*.iso
