name: VyOS 1.4 Sagitta – clean upstream build

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - sagitta

jobs:
  build-sagitta:
    runs-on: ubuntu-22.04

    env:
      DEBIAN_FRONTEND: noninteractive
      UPSTREAM_REPO: https://github.com/vyos/vyos-build.git
      UPSTREAM_BRANCH: sagitta
      BUILD_DIR: vyos-build

    steps:
      # ------------------------------------------------------------
      # 1. Checkout (tylko po to, żeby workflow istniał)
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # 2. Pobranie CZYSTEGO upstream vyos-build
      # ------------------------------------------------------------
      - name: Clone upstream vyos-build (Sagitta)
        run: |
          git clone --depth 1 --branch "${UPSTREAM_BRANCH}" "${UPSTREAM_REPO}" "${BUILD_DIR}"
          ls -la "${BUILD_DIR}"

      # ------------------------------------------------------------
      # 3. Submodules
      # ------------------------------------------------------------
      - name: Init submodules
        run: |
          cd "${BUILD_DIR}"
          git submodule update --init --recursive || true

      # ------------------------------------------------------------
      # 4. Zależności systemowe + Python
      # ------------------------------------------------------------
      - name: Install build dependencies (system + python)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            ca-certificates \
            curl \
            gnupg2 \
            debootstrap \
            live-build \
            pbuilder \
            qemu-utils \
            wget \
            xz-utils \
            python3 \
            python3-pip \
            python3-venv \
            python3-jinja2 \
            python3-psutil \
            python3-git \
            python3-tomli

      # ------------------------------------------------------------
      # 5. Stabilny DNS
      # ------------------------------------------------------------
      - name: Configure DNS
        run: |
          sudo bash -c 'echo "nameserver 1.1.1.1" > /etc/resolv.conf'
          sudo bash -c 'echo "nameserver 8.8.8.8" >> /etc/resolv.conf'
          cat /etc/resolv.conf

      # ------------------------------------------------------------
      # 6. BUILD – jedyna poprawna metoda
      # ------------------------------------------------------------
      - name: Build VyOS Sagitta ISO
        run: |
          set -e
          cd "${BUILD_DIR}"
          sudo ./build-vyos-image iso

      # ------------------------------------------------------------
      # 7. Artefakty
      # ------------------------------------------------------------
      - name: Upload build artifacts
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: vyos-sagitta-build
          path: |
            vyos-build/build
            vyos-build/live
            vyos-build/*.log
